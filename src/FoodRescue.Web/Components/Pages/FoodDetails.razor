@page "/food-details/{Id:guid}"
@attribute [Microsoft.AspNetCore.Authorization.Authorize(Roles = "User,Developer")]
@using FoodRescue.Web.Services
@using FoodRescue.Web.Models
@using System.Text.Json
@using System.Security.Claims;
@inject AuthenticationStateProvider AuthProvider
@inject ReservationService ReservationService
@inject FoodAnalysisStore Store
@inject NavigationManager Navigation
@inject IJSRuntime JS

<div class="container mx-auto px-4 py-8">
    <div class="bg-white rounded-lg shadow-lg p-8 max-w-4xl mx-auto">
        <h2 class="text-lg font-bold text-gray-800 mb-6 border-b pb-2">@caption</h2>

        @if (foodItems != null && foodItems.Any())
        {
            <table class="w-full border border-gray-200 rounded-lg overflow-hidden shadow-sm">
                <thead class="bg-blue-50">
                    <tr>
                        <th class="px-4 py-3 text-left text-gray-700 font-semibold border-b">Produkt</th>
                        <th class="px-4 py-3 text-left text-gray-700 font-semibold border-b">Ilość dostępna</th>
                        <th class="px-4 py-3 text-left text-gray-700 font-semibold border-b">Rezerwuj</th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (var food in foodItems)
                    {
                        <tr class="hover:bg-gray-50 transition-colors">
                            <td class="px-4 py-2 border-b">@food.product</td>
                            <td class="px-4 py-2 border-b">@food.amount</td>
                            <td class="px-4 py-2 border-b">
                                <input type="number"
                                       min="0"
                                       max="@((food.numericAmount ?? 1))"
                                       @bind="food.reserveInput"
                                       class="w-20 border-gray-300 rounded-md px-2 py-1 focus:ring focus:ring-blue-200" />
                            </td>
                        </tr>
                    }
                </tbody>
            </table>

            <div class="flex justify-end mt-6">
                <button class="mt-5 px-6 py-2 bg-blue-500 text-white rounded-lg shadow hover:bg-blue-700 transition"
                        @onclick="ReserveFood">
                    Rezerwuj
                </button>
            </div>
        }
        else
        {
            <p class="text-gray-500 italic text-center mt-6">Brak produktów do wyświetlenia.</p>
        }

        <div class="flex justify-start mt-6">
            <button class="px-6 py-2 bg-gray-300 text-gray-800 rounded-md shadow hover:bg-gray-400 transition"
                    @onclick="GoBack">
                ← Wróć
            </button>
        </div>
    </div>
</div>

@code {
    [Parameter] public Guid Id { get; set; }

    string caption = "";
    List<FoodItem> foodItems = new();

    protected override void OnInitialized()
    {
        var item = Store.Results.FirstOrDefault(r => r.Id == Id);
        if (item != null)
        {
            caption = item.Caption;

            if (item.FoodItems == null || !item.FoodItems.Any())
            {
                try
                {
                    string cleanedJson = item.JsonTable.Replace("`", "")
                                                       .Replace("json", "", StringComparison.OrdinalIgnoreCase)
                                                       .Trim();

                    var foodItemsList = new List<FoodItem>();

                    if (cleanedJson.StartsWith("["))
                    {
                        var itemsArray = JsonSerializer.Deserialize<List<Dictionary<string, string>>>(cleanedJson) ?? new();
                        foreach (var dict in itemsArray)
                        {
                            foreach (var kvp in dict)
                            {
                                foodItemsList.Add(new FoodItem
                                {
                                    product = kvp.Key,
                                    amount = kvp.Value,
                                    numericAmount = ExtractNumericAmount(kvp.Value)
                                });
                            }
                        }
                    }
                    else if (cleanedJson.StartsWith("{"))
                    {
                        var dict = JsonSerializer.Deserialize<Dictionary<string, string>>(cleanedJson) ?? new();
                        foodItemsList = dict.Select(kvp => new FoodItem
                        {
                            product = kvp.Key,
                            amount = kvp.Value,
                            numericAmount = ExtractNumericAmount(kvp.Value)
                        }).ToList();
                    }

                    item.FoodItems = foodItemsList;
                }
                catch (Exception ex)
                {
                    JS.InvokeVoidAsync("console.log", $"JSON parsing failed: {ex.Message}");
                }
            }
            foodItems = item.FoodItems;
        }
    }

    void GoBack() => Navigation.NavigateTo("/food-recognitions");

    public class FoodItem
    {
        public string product { get; set; } = "";
        public string amount { get; set; } = "";
        public int? numericAmount { get; set; }
        public int reserveInput { get; set; } = 0;
    }

    int? ExtractNumericAmount(string amount)
    {
        if (string.IsNullOrWhiteSpace(amount))
            return null;

        var match = System.Text.RegularExpressions.Regex.Match(amount, @"^\d+");
        return match.Success && int.TryParse(match.Value, out int value) ? value : null;
    }

    void ReserveFood()
    {
        foreach (var food in foodItems)
        {
            if (food.reserveInput > 0)
            {
                var authState = AuthProvider.GetAuthenticationStateAsync().Result;
                var user = authState.User;

                // Case 1: numeric value available (standard logic)
                if (food.numericAmount.HasValue && food.reserveInput <= food.numericAmount.Value)
                {


                    
                    var reservation = new FoodReservation
                    {
                        AnalysisId = Id,
                        Product = food.product,
                        ReservedAmount = food.reserveInput,
                        UserId = user.ToString(),
                        ReservedAt = DateTime.UtcNow
                    };

                    ReservationService.AddReservation(reservation);

                    food.numericAmount -= food.reserveInput;
                    var parts = food.amount.Split(" ");
                    food.amount = food.numericAmount == 0
                        ? "Brak"
                        : food.numericAmount + (parts.Length > 1 ? " " + parts[1] : "");

                    food.reserveInput = 0;
                }
                // Case 2: no numeric value ("kilka", "trochę", etc.)
                else if (!food.numericAmount.HasValue)
                {
                    var reservation = new FoodReservation
                    {
                        AnalysisId = Id,
                        Product = food.product,
                        ReservedAmount = 1, // treat as "taken completely"
                        UserId = user.ToString(),
                        ReservedAt = DateTime.UtcNow
                    };

                    ReservationService.AddReservation(reservation);

                    // Mark as taken
                    food.amount = "Brak";
                    food.reserveInput = 0;
                }
            }
        }

        // Update the stored item
        var storedItem = Store.Results.FirstOrDefault(r => r.Id == Id);
        if (storedItem != null)
        {
            storedItem.FoodItems = foodItems;
        }
    }
}
}